name: CI
on:
  push:
env:
  IMAGE: ghcr.io/cloudwebmanage/cwm-minio-api
  UV_VERSION: "0.8.8"
  MIGRATE_VERSION: "v4.18.3"
  MINIO_VERSION: "RELEASE.2025-07-23T15-54-02Z"
  PYTHON_VERSION: "3.12"
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          version: ${{ env.UV_VERSION }}
      - name: install migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/${MIGRATE_VERSION}/migrate.linux-amd64.tar.gz | tar xvz &&\
          mv migrate /usr/local/bin/migrate &&\
          chmod +x /usr/local/bin/migrate
      - name: run tests
        run: |
          docker compose up -d db
          uv sync
          uv run pytest
      - uses: CloudWebManage/cwm-iac/actions/docker-build-push@main
        with:
          image_suffix: cwm-minio-api
          build_args: |
            MINIO_VERSION=${{ env.MINIO_VERSION }}
            PYTHON_VERSION=${{ env.PYTHON_VERSION }}
            UV_VERSION=${{ env.UV_VERSION }}
            MIGRATE_VERSION=${{ env.MIGRATE_VERSION }}
            VERSION=${{ github.sha }}
          deploy_key_b64: ${{ secrets.CWM_WORKER_CLUSTER_DEPLOY_KEY_B64 }}
          deploy_file_path: config/auto-updated/cwm-minio-api/api.yaml
          deploy_content_prefix: |
            cwmMinioApi:
              api:
                image:
          deploy_commit_message: "Update cwm-minio-api/api"
      - name: install minio mc
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          docker run --rm -v /tmp:/tmp --entrypoint cp minio/minio:${MINIO_VERSION} /usr/bin/mc /tmp/mc &&\
          sudo cp /tmp/mc /usr/local/bin/mc &&\
          sudo chmod +x /usr/local/bin/mc
      - name: run e2e tests
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          CWM_MINIO_API_URL: ${{ secrets.CWM_MINIO_API_URL }}
          CWM_MINIO_API_USERNAME: ${{ secrets.CWM_MINIO_API_USERNAME }}
          CWM_MINIO_API_PASSWORD: ${{ secrets.CWM_MINIO_API_PASSWORD }}
          CWM_MINIO_API_EXPECTED_VERSION: ${{ github.sha }}
        run: |
          uv run pytest tests/test_e2e.py -s
